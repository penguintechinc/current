name: Build and Security Scan

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/flask-backend/**'
      - 'tests/smoke/**'
      - '.version'
      - '.github/workflows/build.yml'
      - 'services/flask-backend/requirements.txt'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'services/flask-backend/**'
      - 'tests/smoke/**'
      - '.version'
      - '.github/workflows/build.yml'
      - 'services/flask-backend/requirements.txt'

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit security scan
        id: bandit
        run: |
          bandit -r services/flask-backend/ \
            -f json -o bandit-report.json \
            -ll || true
        continue-on-error: true

      - name: Display bandit results
        if: always()
        run: |
          python3 << 'EOF'
          import json
          try:
              with open('bandit-report.json', 'r') as f:
                  data = json.load(f)
                  print(f"\nBandit Security Report Summary")
                  print(f"==============================")
                  print(f"Metrics: {data.get('metrics', {})}")
                  if data.get('results'):
                      print(f"\nIssues Found: {len(data['results'])}")
                      for issue in data['results'][:10]:
                          print(f"\n- {issue.get('issue_text')}")
                          print(f"  Severity: {issue.get('severity')}")
          except:
              print("Could not parse bandit report")
          EOF

      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install linting tools
        run: pip install flake8 black isort

      - name: Run black check
        run: black --check services/flask-backend/app/ tests/smoke/

      - name: Run isort check
        run: isort --check-only --profile black services/flask-backend/app/ tests/smoke/

      - name: Run flake8
        run: flake8 services/flask-backend/app/ tests/smoke/ --count --select=E9,F63,F7,F82 --show-source

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: services/flask-backend/requirements.txt

      - name: Install dependencies
        run: pip install -r services/flask-backend/requirements.txt pytest pytest-cov requests

      - name: Run tests
        run: pytest tests/smoke/ -v --cov=services/flask-backend --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          VERSION=$(cat .version | xargs)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "EPOCH64=$(date +%s)000" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: |
            current:${{ steps.version.outputs.VERSION }}
            current:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILD_TIME=${{ steps.version.outputs.EPOCH64 }}
